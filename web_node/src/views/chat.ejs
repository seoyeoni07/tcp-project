<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>

  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/nav.css">
</head>

<body>

  <%- include('partials/nav', { title, user, active: 'chat' }) %>

  <div class="chat-wrap" style="display:flex; gap:16px; padding:16px;">

    <!-- 채팅방 목록 -->
    <aside style="width:220px; border:1px solid #ddd; padding:12px;">
      <h2 style="margin-top:0;">채팅방</h2>
      <ul style="list-style:none; padding-left:0;">
        <li>채팅1</li>
        <li>채팅2</li>
      </ul>
    </aside>

    <!-- 메시지 영역 -->
    <main style="
      flex:1; 
      border:1px solid #ddd; 
      padding:12px; 
      display:flex; 
      flex-direction:column; 
      height:500px;
    ">

      <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h2 style="margin:0;">채팅 1</h2>
        <span><%= user && user.user_name ? user.user_name : "Guest" %></span>
      </header>

      <!-- 메시지 출력 -->
      <section id="messages" style="
        flex:1; 
        overflow-y:auto; 
        border:1px solid #eee; 
        padding:8px; 
        margin-bottom:8px;
      "></section>

      <!-- 메시지 입력 -->
      <form id="message-form" style="display:flex; gap:8px;">
        <input
          type="text"
          id="message-input"
          placeholder="메시지를 입력하세요..."
          required
          style="flex:1; padding:6px;"
        />
        <button type="submit">전송</button>
      </form>

    </main>
  </div>
  <script src="/socket.io/socket.io.js"></script> 

    <script>
        const form = document.getElementById('message-form');
        const input = document.getElementById('message-input');
        const messagesSection = document.getElementById('messages');

        console.log("메시지 섹션 참조:", messagesSection);
        
        const currentUserId = "<%= user && user.user_id ? user.user_id : null %>";

        // 소켓 연결
        const socket = io(); 

        function appendMessage(data, isPast = false) {
            const container = document.createElement('div');
            container.classList.add('chat-message');
            
            const item = document.createElement('div');
            item.classList.add('message-bubble');

            const isMyMessage = (data.user_id == currentUserId);
            
            if (isMyMessage) {
              container.classList.add('my-message');
            } else {
              container.classList.add('other-message');
            }
            const sender = isMyMessage ? '나' : data.user_name;
            const msgText = data.message || "메시지 없음";
            const timestamp = data.timestamp;

            item.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 4px;">${sender}</div>
            <div>${msgText}</div>
            <div style="font-size: 10px; opacity: 0.6; text-align: right; margin-top: 4px;">${timestamp}</div>
            `;

            container.appendChild(item);
            messagesSection.appendChild(container);
    }

        form.addEventListener('submit', (e) => {
            e.preventDefault(); // 페이지 새로고침 방지
            const message = input.value.trim();
            
            if (message) {
                socket.emit('chat message', message);
                input.value = '';
            }
        });

        socket.on('past message', (data) => {
            appendMessage(data, true);
        });
        
        socket.on('chat message', (data) => {
            appendMessage(data, false);
            if (messagesSection) {
              messagesSection.scrollTop = messagesSection.scrollHeight;
              } else {
        console.error("messagesSection을 찾을 수 없습니다!");
    }
        });
        
        socket.on('system message', (msg) => {
            const item = document.createElement('div');
            item.textContent = `[시스템] ${msg}`;
            item.style.color = 'gray';
            messagesSection.appendChild(item);

            if (msg.includes('로딩 완료')) {
                 messagesSection.scrollTop = messagesSection.scrollHeight;
            }
        });

    </script>
</body>
</html>
