<% const isLoggedIn = !!user; %>

<header class="nav">
  <div class="nav-left">
    <a href="/home" class="nav-logo">TeamDeskHub</a>
  </div>

  <nav class="nav-menu">
    <a href="/home" class="<%= active === 'home' ? 'active' : '' %>">í™ˆ</a>
    <a href="/chat" class="<%= active === 'chat' ? 'active' : '' %>">ì±„íŒ…</a>
    <a href="/worklog" class="<%= active === 'worklog' ? 'active' : '' %>">ì—…ë¬´ì¼ì§€</a>
    <a href="/meeting" class="<%= active === 'meeting' ? 'active' : '' %>">íšŒì˜ì‹¤ ì˜ˆì•½</a>
    <a href="/board" class="<%= active === 'board' ? 'active' : '' %>">ê²Œì‹œíŒ</a>
    <% if (isLoggedIn && user.role === 'admin') { %>
    <a href="/admin/users" class="<%= active === 'admin' ? 'active' : '' %>">íšŒì›ê´€ë¦¬</a>
  <% } %>
  </nav>

  <div class="nav-right">
    <% if (isLoggedIn) { %>
      <!-- ğŸ†• ìƒíƒœ ë³€ê²½ ë“œë¡­ë‹¤ìš´ -->
      <div class="status-dropdown">
        <button class="status-btn" id="status-btn">
          <span class="status-dot" id="status-dot"></span>
          <span id="status-text">ë¡œë”©ì¤‘</span>
        </button>
        <div class="status-menu" id="status-menu">
          <button class="status-option" data-status="online">
            <span class="status-dot online"></span> ì¶œê·¼ì¤‘
          </button>
          <button class="status-option" data-status="meeting">
            <span class="status-dot meeting"></span> íšŒì˜ì¤‘
          </button>
          <button class="status-option" data-status="out">
            <span class="status-dot out"></span> ì™¸ê·¼
          </button>
          <button class="status-option" data-status="offline">
            <span class="status-dot offline"></span> í‡´ê·¼
          </button>
        </div>
      </div>

      <span class="nav-user"><%= user.user_name || user.email %>ë‹˜</span>
      <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
    <% } else { %>
      <a href="/">ë¡œê·¸ì¸</a>
      <a href="/signup">íšŒì›ê°€ì…</a>
    <% } %>
  </div>
</header>

<% if (isLoggedIn) { %>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  
  const statusLabels = {
    'online': 'ì¶œê·¼ì¤‘',
    'meeting': 'íšŒì˜ì¤‘',
    'out': 'ì™¸ê·¼',
    'offline': 'í‡´ê·¼'
  };

  const currentStatus = '<%= user.work_status || "offline" %>';
  
  // ì´ˆê¸° ìƒíƒœ í‘œì‹œ
  function updateStatusDisplay(status) {
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    
    if (statusDot && statusText) {
      statusDot.className = 'status-dot ' + status;
      statusText.textContent = statusLabels[status] || 'ì•Œ ìˆ˜ ì—†ìŒ';
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ í‘œì‹œ
  updateStatusDisplay(currentStatus);

  // ë“œë¡­ë‹¤ìš´ í† ê¸€
  const statusBtn = document.getElementById('status-btn');
  const statusMenu = document.getElementById('status-menu');

  if (statusBtn && statusMenu) {
    statusBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      statusMenu.classList.toggle('show');
    });

    // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', () => {
      statusMenu.classList.remove('show');
    });

    // ìƒíƒœ ë³€ê²½
    const statusOptions = document.querySelectorAll('.status-option');
    statusOptions.forEach(option => {
      option.addEventListener('click', async (e) => {
        e.stopPropagation();
        const newStatus = option.dataset.status;
        
        try {
          // API í˜¸ì¶œ
          const response = await fetch('/api/status/change', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
          });

          if (response.ok) {
            // Socket.ioë¡œ ì‹¤ì‹œê°„ ì „íŒŒ
            socket.emit('status-change', { status: newStatus });
            
            // UI ì—…ë°ì´íŠ¸
            updateStatusDisplay(newStatus);
            statusMenu.classList.remove('show');
          }
        } catch (error) {
          console.error('ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
          alert('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });
    });
  }
</script>
<% } %>