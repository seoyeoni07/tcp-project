<% const isLoggedIn = !!user; %>

<header class="nav">
  <div class="nav-left">
    <a href="/home" class="nav-logo">TeamDeskHub</a>
    
    <% if (isLoggedIn) { %>
    <div id="online-count" style="
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 16px;
      padding: 6px 12px;
      background: #f3f4f6;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;">
      <span id="online-number" style="color: #2563eb;">-</span>ëª… ì ‘ì†ì¤‘
    </div>
    <% } %>
  </div>

  <nav class="nav-menu">
    <a href="/home" class="<%= active === 'home' ? 'active' : '' %>">í™ˆ</a>
    <a href="/chat" class="<%= active === 'chat' ? 'active' : '' %>">ì±„íŒ…</a>
    <a href="/worklog" class="<%= active === 'worklog' ? 'active' : '' %>">ì—…ë¬´ì¼ì§€</a>
    <a href="/meeting" class="<%= active === 'meeting' ? 'active' : '' %>">íšŒì˜ì‹¤ ì˜ˆì•½</a>
    <a href="/board" class="<%= active === 'board' ? 'active' : '' %>">ê²Œì‹œíŒ</a>
    <% if (isLoggedIn && user.role === 'admin') { %>
    <a href="/admin/users" class="<%= active === 'admin' ? 'active' : '' %>">íšŒì›ê´€ë¦¬</a>
  <% } %>
  </nav>

  <div class="nav-right">
    <% if (isLoggedIn) { %>
      <div class="notification-dropdown">
        <button class="notification-bell-btn" id="notification-bell-btn">
          ğŸ””
          <%
          let initialTotalCount = 0;
          let initialUnreadCount = 0;
          let initialNewNoticeCount = 0;
          let initialTodayMeetingCount = 0;
          if (typeof unreadCount !== 'undefined' && typeof newNoticeCount !== 'undefined' && typeof todayMeetingCount !== 'undefined') {
            initialUnreadCount = unreadCount || 0;
            initialNewNoticeCount = newNoticeCount || 0;
            initialTodayMeetingCount = todayMeetingCount || 0;
            initialTotalCount = initialUnreadCount + initialNewNoticeCount + initialTodayMeetingCount;
          } %>
          <span class="notification-badge" style="<%= initialTotalCount > 0 ? '' : 'display:none;' %>">
            <%= initialTotalCount > 0 ? initialTotalCount : '' %>
          </span>
        </button>
        
        <div class="notification-menu" id="notification-menu">
          <div class="notification-header">ì•Œë¦¼</div>
          
          <% if (initialUnreadCount > 0 || initialNewNoticeCount > 0 || initialTodayMeetingCount > 0) { %>
            <div class="notification-list">
              <% if (initialUnreadCount > 0) { %>
              <a href="/chat" class="notification-item unread-msg">
                <div class="notification-content">
                  <div class="notification-title">ì½ì§€ ì•Šì€ ë©”ì‹œì§€</div>
                  <div class="notification-desc"><%= initialUnreadCount %>ê°œì˜ ìƒˆ ë©”ì‹œì§€</div>
                </div>
              </a>
              <% } %>
              
              <% if (initialNewNoticeCount > 0) { %>
              <a href="/board" class="notification-item new-notice">
                <div class="notification-content">
                  <div class="notification-title">ìƒˆ ê³µì§€ì‚¬í•­</div>
                  <div class="notification-desc"><%= initialNewNoticeCount %>ê°œì˜ ê³µì§€</div>
                </div>
              </a>
              <% } %>
              
              <% if (initialTodayMeetingCount > 0) { %>
              <a href="/meeting" class="notification-item meeting">
                <div class="notification-content">
                  <div class="notification-title">ì˜¤ëŠ˜ íšŒì˜ì‹¤ ì˜ˆì•½</div>
                  <div class="notification-desc"><%= initialTodayMeetingCount %>ê±´ì˜ ì˜ˆì•½</div>
                </div>
              </a>
              <% } %>
            </div>
          <% } else { %>
            <div class="notification-empty" id="notification-empty">
              ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤
            </div>
          <% } %>
        </div>
      </div>

      <div class="status-dropdown">
        <button class="status-btn" id="status-btn">
          <span class="status-dot" id="status-dot"></span>
          <span id="status-text">ë¡œë”©ì¤‘</span>
        </button>
        <div class="status-menu" id="status-menu">
          <button class="status-option" data-status="online">
            <span class="status-dot online"></span> ì¶œê·¼ì¤‘
          </button>
          <button class="status-option" data-status="meeting">
            <span class="status-dot meeting"></span> íšŒì˜ì¤‘
          </button>
          <button class="status-option" data-status="out">
            <span class="status-dot out"></span> ì™¸ê·¼
          </button>
          <button class="status-option" data-status="offline">
            <span class="status-dot offline"></span> í‡´ê·¼
          </button>
        </div>
      </div>

      <span class="nav-user"><%= user.user_name || user.email %>ë‹˜</span>
      <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
    <% } else { %>
      <a href="/">ë¡œê·¸ì¸</a>
      <a href="/signup">íšŒì›ê°€ì…</a>
    <% } %>
  </div>
</header>

<style>
  .notification-dropdown {
    position: relative;
    display: inline-block;
  }

  .notification-bell-btn {
    position: relative;
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: background 0.2s;
  }

  .notification-bell-btn:hover {
    background: #f3f4f6;
  }

  .notification-badge {
    position: absolute;
    top: 2px;
    right: 2px;
    background: #ef4444;
    color: white;
    border-radius: 999px;
    padding: 2px 6px;
    font-size: 11px;
    font-weight: 700;
    min-width: 18px;
    text-align: center;
  }

  .notification-menu {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    width: 320px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: none;
    z-index: 1000;
    max-height: 400px;
    overflow-y: auto;
  }

  .notification-menu.show {
    display: block;
  }

  .notification-header {
    padding: 12px 16px;
    font-weight: 700;
    font-size: 15px;
    border-bottom: 1px solid #e5e7eb;
    color: #111827;
  }

  .notification-list {
    display: flex;
    flex-direction: column;
  }

  .notification-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    text-decoration: none;
    color: #111827;
    border-bottom: 1px solid #f3f4f6;
    transition: background 0.2s;
  }

  .notification-item:last-child {
    border-bottom: none;
  }

  .notification-item:hover {
    background: #f9fafb;
  }

  .notification-item.unread-msg {
    background: #eff6ff;
  }

  .notification-item.unread-msg:hover {
    background: #dbeafe;
  }

  .notification-item.new-notice {
    background: #fef3c7;
  }

  .notification-item.new-notice:hover {
    background: #fde68a;
  }

  .notification-item.meeting {
    background: #d1fae5;
  }

  .notification-item.meeting:hover {
    background: #a7f3d0;
  }

  .notification-icon {
    font-size: 24px;
    flex-shrink: 0;
  }

  .notification-content {
    flex: 1;
  }

  .notification-title {
    font-size: 14px;
    font-weight: 600;
    color: #111827;
    margin-bottom: 2px;
  }

  .notification-desc {
    font-size: 12px;
    color: #6b7280;
  }

  .notification-empty {
    padding: 40px 16px;
    text-align: center;
    color: #9ca3af;
    font-size: 14px;
  }
</style>

<% if (isLoggedIn) { %>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  
  const statusLabels = {
    'online': 'ì¶œê·¼ì¤‘',
    'meeting': 'íšŒì˜ì¤‘',
    'out': 'ì™¸ê·¼',
    'offline': 'í‡´ê·¼'
  };

  const currentStatus = '<%= user.work_status || "offline" %>';
  
  function updateStatusDisplay(status) {
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    
    if (statusDot && statusText) {
      statusDot.className = 'status-dot ' + status;
      statusText.textContent = statusLabels[status] || 'ì•Œ ìˆ˜ ì—†ìŒ';
    }
  }

  updateStatusDisplay(currentStatus);

  const numberEl = document.getElementById("online-number");
  if (numberEl) {
    socket.on("online count", (count) => {
      numberEl.textContent = count;
    });
  }
  
  const totalNotificationBadge = document.querySelector('.notification-badge'); 
  const notificationMenu = document.getElementById('notification-menu');

  /**
   * ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ë‚´ìš©ì„ ê°±ì‹ í•©ë‹ˆë‹¤.
   * @param {object} counts - { unreadCount, newNoticeCount, todayMeetingCount, ... }
   */
  function updateNotificationMenu(counts) {
    const { unreadCount, newNoticeCount, todayMeetingCount } = counts;
    const hasNotifications = (unreadCount > 0) || (newNoticeCount > 0) || (todayMeetingCount > 0);
    
    if (!notificationMenu) return;

    let contentHTML = '<div class="notification-header">ì•Œë¦¼</div>';
    
    if (hasNotifications) {
      contentHTML += '<div class="notification-list">';
      
      if (unreadCount > 0) {
        contentHTML += `
          <a href="/chat" class="notification-item unread-msg">
            <div class="notification-content">
              <div class="notification-title">ì½ì§€ ì•Šì€ ë©”ì‹œì§€</div>
              <div class="notification-desc">${unreadCount}ê°œì˜ ìƒˆ ë©”ì‹œì§€</div>
            </div>
          </a>
        `;
      }
      
      if (newNoticeCount > 0) {
        contentHTML += `
          <a href="/board" class="notification-item new-notice">
            <div class="notification-content">
              <div class="notification-title">ìƒˆ ê³µì§€ì‚¬í•­</div>
              <div class="notification-desc">${newNoticeCount}ê°œì˜ ê³µì§€</div>
            </div>
          </a>
        `;
      }
      
      if (todayMeetingCount > 0) {
        contentHTML += `
          <a href="/meeting" class="notification-item meeting">
            <div class="notification-content">
              <div class="notification-title">ì˜¤ëŠ˜ íšŒì˜ì‹¤ ì˜ˆì•½</div>
              <div class="notification-desc">${todayMeetingCount}ê±´ì˜ ì˜ˆì•½</div>
            </div>
          </a>
        `;
      }

      contentHTML += '</div>';
    } else {
      contentHTML += '<div class="notification-empty">ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    }

    notificationMenu.innerHTML = contentHTML;
  }
  

  socket.on('new notice notification', (data) => {
      console.log(`[ìƒˆ ê³µì§€ ì•Œë¦¼ ìˆ˜ì‹ ] ì œëª©: ${data.title}, ID: ${data.post_id}`);
  });

  socket.on('new message notification', (messageData) => {
      console.log(`[ìƒˆ ì±„íŒ… ë©”ì‹œì§€ ì•Œë¦¼] ${messageData.user_name}: ${messageData.message}`);

  });

  socket.on('new room created', (roomInfo) => {
      console.log(`[ìƒˆ ì±„íŒ…ë°© ìƒì„±] ì´ë¦„: ${roomInfo.room_name}`);

  });

  socket.on('update total count', (data) => {
    if (typeof data.totalCount === 'undefined') return;

    const newTotal = Number(data.totalCount);

    if (totalNotificationBadge) {
        if (newTotal > 0) {
          totalNotificationBadge.textContent = newTotal;
          totalNotificationBadge.style.display = 'inline-block';
        } else {
          totalNotificationBadge.style.display = 'none';
          totalNotificationBadge.textContent = '';
        }
    }
    
    if (data.unreadCount !== undefined) {
      updateNotificationMenu(data);
    }
  });

  const notificationBellBtn = document.getElementById('notification-bell-btn');

  if (notificationBellBtn && notificationMenu) {
    notificationBellBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      notificationMenu.classList.toggle('show');
      const statusMenu = document.getElementById('status-menu');
      if (statusMenu) statusMenu.classList.remove('show');
    });

    document.addEventListener('click', () => {
      notificationMenu.classList.remove('show');
    });
  }

  const statusBtn = document.getElementById('status-btn');
  const statusMenu = document.getElementById('status-menu');

  if (statusBtn && statusMenu) {
    statusBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      statusMenu.classList.toggle('show');
      if (notificationMenu) notificationMenu.classList.remove('show');
    });

    document.addEventListener('click', () => {
      statusMenu.classList.remove('show');
    });

    const statusOptions = document.querySelectorAll('.status-option');
    statusOptions.forEach(option => {
      option.addEventListener('click', async (e) => {
        e.stopPropagation();
        const newStatus = option.dataset.status;
        
        try {
          const response = await fetch('/api/status/change', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
          });

          if (response.ok) {
            socket.emit('status-change', { status: newStatus });
            
            updateStatusDisplay(newStatus);
            statusMenu.classList.remove('show');
          }
        } catch (error) {
        }
      });
    });
  }
</script>
<% } %>