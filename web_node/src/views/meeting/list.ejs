<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>회의실 예약</title>

  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/nav.css" />
  <link rel="stylesheet" href="/css/board.css" />
</head>
<body>

  <%- include('../partials/nav', { title, user, active: 'meeting' }) %>

  <div class="board-wrap">

    <div class="board-header">
      <h1 class="board-title">회의실 예약</h1>
      <div class="board-header-right">
        <form method="get" action="/meeting">

          <input type="hidden" name="year"  value="<%= year %>">
          <input type="hidden" name="month" value="<%= month %>">

          <button type="submit" name="prev" value="1">◀</button>
          <span><%= year %>년 <%= month %>월</span>
          <button type="submit" name="next" value="1">▶</button>
          <a href="/meeting">오늘</a>
        </form>
      </div>
    </div>

    <div class="calendar-wrap">
      <table class="calendar-table">
        <thead>
          <tr>
            <th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th>
          </tr>
        </thead>
        <tbody>
          <%

            var firstDate = new Date(year, month - 1, 1);
            var firstDay  = firstDate.getDay();           
            var lastDate  = new Date(year, month, 0).getDate();
            var day = 1 - firstDay;                         

            for (var week = 0; week < 6; week++) {
          %>
            <tr>
              <%
                for (var d = 0; d < 7; d++, day++) {
                  var valid = (day >= 1 && day <= lastDate);
                  var yyyy = String(year);
                  var mm   = String(month);
                  if (mm.length === 1) mm = '0' + mm;
                  var dd   = String(day);
                  if (dd.length === 1) dd = '0' + dd;

                  var key  = valid ? (yyyy + '-' + mm + '-' + dd) : null;
                  var items = valid ? (reservationsByDate[key] || []) : [];
              %>
                <td class="<%= valid ? 'cal-cell' : 'cal-empty' %>"
                    data-date="<%= key %>">
                  <% if (valid) { %>
                    <div class="cal-date"><%= day %></div>
                    <div class="cal-badges">
                      <% if (items.length === 0) { %>
                        <span class="cal-empty-text">예약 없음</span>
                      <% } else { %>
                        <%
                          var max = (items.length < 2) ? items.length : 2;
                          for (var i = 0; i < max; i++) {
                            var r = items[i];
                        %>
                          <div class="cal-item">
                            <%= r.room_name %> /
                            <%= r.start_time.substring(11,16) %>
                          </div>
                        <% } %>

                        <% if (items.length > 2) { %>
                          <div class="cal-more">+<%= items.length - 2 %>건</div>
                        <% } %>
                      <% } %>
                    </div>
                  <% } %>
                </td>
              <% } %>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <div class="board-header" style="margin-top:24px;">
      <h2 class="board-title" id="selected-date-title">오늘 예약 현황</h2>
      <a id="reserve-btn" class="btn btn-primary" href="/meeting/reserve/1">예약하기</a>
    </div>

    <table class="board-table" id="reservation-table">
      <thead>
        <tr>
          <th class="col-title">회의실</th>
          <th class="col-date">시작</th>
          <th class="col-date">종료</th>
          <th class="col-author">예약자</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <script>
    var RES_BY_DATE = <%- JSON.stringify(reservationsByDate || {}) %>;

    var cells      = document.querySelectorAll('.cal-cell');
    var tbody      = document.querySelector('#reservation-table tbody');
    var titleEl    = document.querySelector('#selected-date-title');
    var reserveBtn = document.querySelector('#reserve-btn');

    function renderDate(dateKey) {
      var list = RES_BY_DATE[dateKey] || [];
      titleEl.textContent = dateKey + ' 예약 현황';

      reserveBtn.href = '/meeting/reserve/1?date=' + encodeURIComponent(dateKey);

      tbody.innerHTML = '';
      if (list.length === 0) {
        var trEmpty = document.createElement('tr');
        var tdEmpty = document.createElement('td');
        tdEmpty.colSpan = 4;
        tdEmpty.textContent = '예약이 없습니다.';
        tdEmpty.className = 'empty-row';
        trEmpty.appendChild(tdEmpty);
        tbody.appendChild(trEmpty);
        return;
      }

      list.forEach(function (r) {
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + r.room_name + '</td>' +
          '<td>' + r.start_time.substring(11, 16) + '</td>' +
          '<td>' + r.end_time.substring(11, 16) + '</td>' +
          '<td>' + r.user_name + '</td>';
        tbody.appendChild(tr);
      });
    }

    cells.forEach(function (cell) {
      cell.addEventListener('click', function () {
        var dateKey = cell.dataset.date;
        if (!dateKey) return;
        renderDate(dateKey);
      });
    });

    (function () {
      var today = new Date();
      var y = today.getFullYear();
      var m = String(today.getMonth() + 1);
      if (m.length === 1) m = '0' + m;
      var d = String(today.getDate());
      if (d.length === 1) d = '0' + d;
      var todayKey = y + '-' + m + '-' + d;

      var currentYear  = <%= year %>;
      var currentMonth = <%= month %>;

      if (currentYear !== y || currentMonth !== (today.getMonth() + 1)) {
        var cellsArr = Array.prototype.slice.call(cells);
        for (var i = 0; i < cellsArr.length; i++) {
          var key = cellsArr[i].dataset.date;
          if (key) {
            todayKey = key;
            break;
          }
        }
      }

      renderDate(todayKey);
    })();
  </script>
</body>
</html>
